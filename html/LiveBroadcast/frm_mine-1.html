<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>播放</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/static.css"/>
    <style>
        #warp, html, body {
            background: transparent;
        }

        #warp {
            position: absolute;
            width: 100%;
        }

        #header {
            display: flex;
            position: fixed;
            width: 100%;
            height: 2.4rem;
            line-height: 2.4rem;
            z-index: 1000000;
            background-color: transparent;
        }

        .left-box {
            font-size: 1rem;
            margin-left: 0.5rem;
        }

        .right-box {
            position: absolute;
            right: 10px;
        }

        .view {
            height: 12rem;
            position: relative;
            width: 100%;
            background-repeat: no-repeat;
            background-size: cover;
        }

        .Count_down {
            display: -webkit-box;
            position: absolute;
            bottom: 0px;
            height: 2.4rem;
            -webkit-box-align: center;
            width: 100%;
        }

        .Count_down > div {
            -webkit-box-flex: 1;
        }

        .live_now_btn {
            width: 25%;
            padding: 0.3rem 0;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            font-size: 0.6rem;
            margin-right: 1rem;
            background-color: #F3CA7F;
        }

        .nav {
            display: -webkit-box;
            -webkit-box-align: center;
            height: 2.3rem;
            background-color: #fff;
        }

        .nav > div {
            -webkit-box-flex: 1;
            text-align: center;
            font-size: 0.75rem;
            height: 2.2rem;
            line-height: 2.2rem;
            color: #666;
            border-bottom: 2px solid #ddd;
        }

        .navliat {
            color: #d9b270;
            height: 2.2rem;
            line-height: 2.2rem;
            border-bottom: 6px solid #d9b270 !important;
        }

        .makeStyle {
            transition: background-color 1s, color 1s, border 1s;
            background-color: rgba(0, 0, 0, .3);
            border: 1px solid #FF9A35;
            color: #FF9A35;
        }

        .list_Two {
            background-color: #fff !important;
        }

        .textWin {
            width: 100%;
            position: fixed;
            bottom: 0px;
            height: 2.75rem;
            box-sizing: border-box;
            padding: 10px 15px;
            line-height: 2.75rem;
            display: -webkit-box;
            background-color: #ebebeb;
        }

        .textWin > div {
            -webkit-box-flex: 1;
            height: 1.8rem;
            text-indent: 1rem;
            font-size: 0.7rem;
            line-height: 1.8rem;
            border-radius: 8px;
            color: #999;
            background-color: #fff;
        }

        .page {
            position: absolute;
            padding-top: 1rem;
            height: 100%;
            width: 100%;
            overflow-y: auto;
            padding-bottom: 1.5rem;
            background-color: #fff;
        }

        .time {
            display: -webkit-box;
            -webkit-box-align: center;
            -webkit-box-pack: center;
        }

        .time > div {
            background-color: #b2b2b2;
            color: #fff;
            height: 1.5rem;
            padding: 0px 15px;
            line-height: 1.6rem;
            border-radius: 1.5rem;
        }

        .wan_right, .man_left {
            box-sizing: border-box;
            padding: 0 10px;
            display: -webkit-box;
            margin-top: 0.75rem;
        }

        .man_left > img {
            border-radius: 100%;
            margin-right: 1rem;
            width: 40px;
        }

        .wan_right > div, .man_left > div {
            -webkit-box-flex: 1;
        }

        .wan_right > img {
            border-radius: 100%;
            width: 40px;
        }

        .wan_right > div {
            padding-right: 1rem;
        }

        .nickname {
            height: 40px;
            line-height: 40px;
            font-size: 0.75rem;
        }

        .nicknames {
            text-align: right;
            height: 40px;
            line-height: 40px;
            font-size: 0.75rem;
        }

        .desc {
            margin-top: 1rem;
            font-size: 0.7rem;
            border-radius: 0px 20px 20px 20px;
            position: relative;
            margin-right: 3.5rem;
            word-wrap: break-word;
            background-color: #f5f5f9;
            padding: 10px;
            display: inline-block;
        }

        .descs {
            margin-top: 1rem;
            font-size: 0.7rem;
            border-radius: 20px 0px 20px 20px;
            position: relative;
            margin-left: 3.5rem;
            word-wrap: break-word;
            display: inline-block;
            background-color: #f5f5f9;
            padding: 10px;
            float: right;
        }

        .descs > p {
            width: 0;
            position: absolute;
            top: -16px;
            height: 0;
            right: 0px;
            border-bottom: 8px solid #f5f5f9;
            border-top: 8px solid transparent;
            border-right: 8px solid #f5f5f9;
            border-left: 8px solid transparent;
        }

        .desc > p {
            width: 0;
            position: absolute;
            top: -16px;
            height: 0;
            left: 0px;
            border-bottom: 8px solid #f5f5f9;
            border-top: 8px solid transparent;
            border-left: 8px solid #f5f5f9;
            border-right: 8px solid transparent;
        }

        .span {
            color: #fff211;
            margin-left: 10px;
            margin-right: 10px;
        }

        .navlist {
            color: #d9b270 !important;
            border-bottom: 3px solid #d9b270 !important;
        }
    </style>
</head>
<body style="background: #fff">
<div id="warp">
    <div style="position: relative;width: 100%;top: 0px;">
        <header class="aui-bar aui-bar-nav" id="header" style="border-bottom: 0px;color:white;">
            <a class="left-box iconfont icon-jiantou z-fanhui" @click="closeWins()"></a>
            <span class="aui-title" style="">直播</span>
            <span class="right-box"></span>
        </header>
        <!--未开始直播-->
        <div v-show="true" class="view" id="view"
             :style="'background-image: url('+ formatImg(zhibo_deilde.img) +')'">
            <div style="padding-left: 0.6rem; color: #fff;">
                <div style="font-size: 1rem;padding-top:4rem; color: #000;padding-left: 0.7rem;">{{zhibo_deilde.name}}
                </div>
                <div style="font-size: 0.6rem;padding:0.3rem 0;padding-left: 0.7rem;">{{zhibo_deilde.des}}</div>
                <div style="font-size: 0.7rem;padding-left: 0.7rem;">{{Year}}年{{yue}}月{{day}}日&nbsp;&nbsp;{{times}}准时开启
                </div>
            </div>
            <div class="Count_down">
                <div style="font-size: 0.6rem;padding-left: 0.6rem;color: #fff;">
                    直播倒计时：<span>{{int_day >0 ? int_day : '00'}}</span>天<span
                >{{int_hour >0 ? int_hour : '00'}}</span>小时<span>{{int_minute >0 ? int_minute : '00'}}</span>分钟<span>{{int_second >0 ? int_second : '00'}}</span>秒
                </div>
                <div class="live_now_btn" :class="{makeStyle : makeapp  }" @click="makeAppointment()">
                    {{appointment}}
                </div>
            </div>
        </div>
        <p class="p" style="height: 0.35rem;background-color: #f4f4f4;"></p>
        <div class="nav">
            <div v-for="(item,index) in nav" :class="{'navlist' :index==nus}" @click="changIndex(index)">{{item}}
            </div>
        </div>
    </div>
    <div id="tadle" style="background-color: #fff;">
        <!-------------------------- 主讲 ------------------------->
        <div class="list_Two" id="list_01" v-show=" nus == 0">
            <div class="page" id="box">
                <div class="time">
                    <div>2017-08-11 12:66</div>
                </div>
                <div class="man_left">
                    <img src="../../image/logo.png" alt="">
                    <div>
                        <div class="nickname">管理员</div>
                        <div class="desc"><p></p>假信息测试
                        </div>
                    </div>
                </div>
            </div>
            <div class="textWin">
                <div @click="openthis()">请输入您想说的话</div>
            </div>
        </div>
        <!--------------------- 互动 ---------------------->
        <div class="list_Two" id="list_02" v-show=" nus == 1">
            <div class="page" id="perPage">
                <div class="time">
                    <div>2017-08-11 12:66</div>
                </div>
                <div class="man_left">
                    <img src="../../image/logo.png" alt="">
                    <div>
                        <div class="nickname">管理员
                            <span class="span">
          <!--<img v-show="mYlist.index == 1" src="../../image/huangguan02.png" alt="">-->
                                <!--<img v-show="2 <= mYlist.index && mYlist.index <= 20" src="../../image/zuanshi0.png" alt="">-->
                                <!--<img v-show="21 <= mYlist.index && mYlist.index < 100" src="../../image/huangjin02.png" alt="">-->
                                <!--<img v-show="100 <= mYlist.index && mYlist.index <= 500" src="../../image/baiyin02.png" alt="">-->
                                <!--<img v-show="500 < mYlist.index" src="../../image/qingtong02.png" alt="">-->
                                <!--<img v-show="mYlist.index == 0" src="../../image/qingtong02.png" alt="">-->
                                <!--<img v-show="mYlist.index == null" src="../../image/qingtong02.png" alt="">-->
          硕士三年级
        </span>
                        </div>
                        <div class="desc"><p></p>管理员发言测试
                        </div>
                    </div>
                </div>
                <div class="wan_right">
                    <div>
                        <div class="nicknames">
          <span class="span">
          硕士三年级
        </span>管理员
                        </div>
                        <div class="descs"><p></p>哈哈哈er
                        </div>
                    </div>
                    <img src="../../image/logo.png" alt="">
                </div>
            </div>
            <div class="textWin">
                <div @click="openthis()">请输入您想说的话</div>
            </div>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/vue.min.js"></script>
<script type="text/javascript" src="../../script/jquery.min.js"></script>
<script type="text/javascript" src="../../script/App.js"></script>
<script type="text/javascript" src="../../script/vue-resource.js"></script>
<script type="text/javascript" src="../../script/public.js"></script>
<script type="text/javascript">
  var app = new Vue({
    el: '#warp',
    data: {
      makeapp: false,
      nus: 0,
      appointment: '立即预约',
      renList: 0,
      countTime: '',
      nav: ['主讲', '互动'],
      int_day: '',
      int_hour: '',
      int_minute: '',
      int_second: '',
      times: '',
      Year: '',
      yue: '',
      day: '',
      ss: '',
      ff: '',
      mm: '',
      count: 0,
      numbers: '0',
      MuteStatus: true,
      zhibo_deilde: {},
      session: {},
      palyer: {}
    },
    created: function () {
      apiready = function () {
        $api.fixStatusBar($api.dom('header'));
        app.session = api.pageParam.session;
        var chat = api.require('gotyeLiveChat');
        app.palyer = api.require('gotyeLivePlayer');
        var playe = app.palyer;

        // 参数
        var offset = document.querySelector('.view').offsetHeight;
        chat.init(app.session);
        chat.login(function (ret, err) {
          if (ret) {
            //获取登录后返回的account作为连麦所需要的localId
            localId = ret.account;
            app.insertChartContent('sys', '系统', '连接聊天服务器成功');
            $api.setStorage('nickname', ret.nickname)
            //获取聊天室当前人数
            chat.getRoomMemberCount(function (ret, err) {
              if (ret) {
                api.sendEvent({
                  name: 'myCount',
                });
                $api.setStorage('count', ret.count)
              } else {
                toastMsg(JSON.stringify(err))
              }
            });
          } else {
            app.insertChartContent('syserro', '系统', '连接聊天服务器失败');
          }
        });
//        监听服务器推送消息
        chat.addEventListener({
          name: 'receiveMsg'
        }, function (ret, err) {
          if (ret) {
            app.insertChartContent('user', ret.sendName, ret.text);
          }
        });
//        账号异常
        chat.addEventListener({
          name: 'forceLogout'
        }, function (ret, err) {
          api.alert({
            msg: '您的账号在另外的设备登录，当前设备被强制下线',
            buttons: ['知道了']
          }, function (ret, err) {
            if (ret.buttonIndex == '1') {
              close();
            }
          });
        });
        // 直播间人数
        chat.getRoomMemberCount(function (ret, err) {
          if (ret) {
            app.numbers = ret.count
          }
        });
        // 模块
//        api.toast({
//          msg: '正在连接直播服务器...',
//          duration: 2000,
//          location: 'center'
//        });
        if (api.pageParam.fullScreen) {
          app.play(true);
        } else {
          app.play(false);
        }
        playe.setDisplayMode({mode: 'aspectFill'});
        playe.addEventListener({
          name: 'liveStart'
        }, function (ret, err) {
          api.toast({
            msg: '直播开始',
            duration: 2000,
            location: 'center'
          });
        });
        playe.addEventListener({
          name: 'liveStop'
        }, function (ret, err) {
          playe.stop();
          api.toast({
            msg: '直播结束',
            duration: 2000,
            location: 'center'
          });
        });
        playe.addEventListener({
          name: 'connected'   //监听链接服务器
        }, function (ret, err) {
          api.toast({
            msg: '连接直播服务器成功',
            duration: 2000,
            location: 'center'
          });
          app.getMuteStatus();

        });
        playe.addEventListener({
          name: 'error'
        }, function (ret, err) {
          switch (ret.code) {
            case -103:
              toastMsg('直播间加载错误,请退出重试')
              break;
            case -104:
              toastMsg('直播还未开始');
              break;
            default:
              toastMsg(ret.description)
              break;
          }
        });
        app.get_live_info()
      }
      screll_1()
    },
    methods: {
      insertChartContent: function (type, sender, content) {
        if (type == 'sys')
          $('#perPage').append('<div class="man_left"><img src="../../image/tx_icon.png" alt=""><div><div class="nickname">系统<span class="span">硕士三年级 </span></div><div class="desc"><p></p>' + content + '</div> </div></div>');
        else if (type == 'syserro')
          $('#perPage').append('<div class="man_left"><img src="../../image/tx_icon.png" alt=""><div><div class="nickname">系统<span class="span">硕士三年级 </span></div><div class="desc"><p></p>' + content + '</div> </div></div>');
        else if (type == 'user')
          $('#perPage').append('<div class="man_left"><img src="../../image/tx_icon.png" alt=""><div><div class="nickname">' + sender + '<span>硕士三年级 </span></div><div class="desc"><p></p>' + content + '</div> </div></div>');
        else
//          $('#perPage').append('<div class="wan_right"><div><div class="nicknames"><span>硕士三年级</span>' + sender + '</div><div class="descs"><p></p>' + content + '</div></div><img src="../../image/logo.png" alt=""></div>');
          $('#perPage').append('<div class="wan_right"><div><div class="nicknames"><span></span>' + sender + '</div><div class="descs"><p></p>' + content + '</div></div><img src="../../image/logo.png" alt=""></div>');
        screll_2()
      },
      openthis: function () {
        var _this = this
        $('.textWin').css('display', 'none')
        var UIChatBox = api.require('UIChatBox');
        UIChatBox.open({
          placeholder: '请输入您想说的话',
          maxRows: 4,
          autoFocus: true,
          emotionPath: 'widget://res/chatbox/emotion',
          texts: {
            recordBtn: {
              normalTitle: '按住说话',
              activeTitle: '松开结束'
            },
            sendBtn: {
              title: '发送'
            }
          },
          styles: {
            inputBar: {
              borderColor: '#d9d9d9',
              bgColor: '#f2f2f2'
            },
            inputBox: {
              borderColor: '#B3B3B3',
              bgColor: '#FFFFFF'
            },
            emotionBtn: {
              normalImg: 'widget://res/chatbox/face1.png'
            },
            keyboardBtn: {
              normalImg: 'widget://res/chatbox/key3.png'
            },
            indicator: {
              target: 'both',
              color: '#c4c4c4',
              activeColor: '#9e9e9e'
            },
            sendBtn: {
              titleColor: '#fff',
              bg: '#5099FB',
              activeBg: '#2e73d0',
              titleSize: 12
            }
          },
          extras: {
            titleSize: 12,
            titleColor: '#a3a3a3',
            btns: []
          }
        }, function (ret, err) {
          if (ret) {
            if (ret.eventType == 'send') {
              var chat = api.require('gotyeLiveChat');
              chat.sendMessage({text: ret.msg}, function (rets, err) {
                if (err) {
                  alert(JSON.stringify(err));
                } else {
                  _this.insertChartContent('me', $api.getStorage('nickname'), ret.msg)
                  UIChatBox.closeKeyboard()
                  UIChatBox.close();
                  $('.textWin').css('display', 'block')
                }
              });
            }
          }
        });
      },
      //  直播的信息
      get_live_info: function () {
        var token = $api.getStorage('token')
        var post = {
          hash: token
        }
        sendAjax(this, post, '/Api/Data/get_live_info', function (res) {
//          alert(JSON.stringify(res))
          app.zhibo_deilde = res.data
          app.makeapp = res.data.yuyue
          if (res.data.yuyue) {
            app.appointment = '已预约';
          } else {
            app.appointment = '立即预约';
          }
          app.Year = res.data.start_time.slice(0, 4)
          app.yue = res.data.start_time.slice(5, 7)
          app.day = res.data.start_time.slice(8, 10)
          app.times = res.data.start_time.split(' ')[1];
          app.ss = res.data.start_time.slice(11, 13)
          app.ff = res.data.start_time.slice(14, 16)
          app.mm = res.data.start_time.slice(17, 19)
          app.startTime = res.data.start_time.replace(/-/g, '/');
          console.log(app.startTime);
          setTimeout("app.show_time()", 1000)
        })
      },
      //  预约function
      yuyues: function () {
        var token = $api.getStorage('token')
        var post = {
          hash: token
        }
        sendAjax(this, post, '/Api/Data/yuyue', function (res) {
          api.toast({
            msg: res.data,
            duration: 2000,
            location: 'bottom'
          })
        })
      },
      // 是否预约
      makeAppointment: function () {
        app.yuyues()
        api.execScript({name: 'FM', script: "app.get_live_info()"});
        if (app.makeapp) {
          app.makeapp = false;
          app.appointment = '立即预约';
        } else {
          app.makeapp = true;
          app.appointment = '已预约';
        }
      },
      destroyRoomSession: function () {
        var core = api.require('gotyeLiveCore');
        core.destroyRoomSession(app.session);
      },
      // 选项卡
      changIndex: function (n) {
        app.nus = n;
        switch (n) {
          case 0:
            document.getElementById('list_01').style.display = 'block'
            document.getElementById('list_02').style.display = 'none'
            screll_1()
            break;
          case 1:
            document.getElementById('list_01').style.display = 'none'
            document.getElementById('list_02').style.display = 'block'
            screll_2()
            break
        }
      },
      setMute: function (atl) {
        var player = app.palyer;
        if (atl) {
          player.setMute({mute: false});
        } else {
          player.setMute({mute: true});
        }
      },
      //   是否开启声音
      getMuteStatus: function () {
        var player = app.palyer;
        player.getMuteStatus(function (ret) {
          if (ret) {
//            alert(JSON.stringify(ret));
            app.MuteStatus = ret.mute
          }
        });
      },
      // 音频视频
      yin_shi: function (well) {
        if (well = true) {

        }
      },
      // 是否是全屏
      play: function (full) {
        var player = app.palyer;
        var offset = document.querySelector('.view').offsetHeight;
        player.init({session: app.session});
        player.switchToQuality({quality: 'high'});
        player.setDisplayMode({mode: 'aspectFill'});
        if (!full) {
          // 初始化播放器（观众角度）
          player.play({
            playView: 'frm_mine',
            rect: {
              x: 0,
              y: 0,
              w: api.frameWidth,
              h: offset
            },
            fixed: true
          });
          api.openFrame({
            name: 'speaker',
            url: './speaker.html',
            pageParam: {
              MuteSta: app.MuteStatus,
              number: app.numbers
            },
            rect: {
              x: 0,
              y: 0,
              w: 'auto',
              h: offset
            },
            bounces: false,
            bgColor: 'rgba(0,0,0,0)',
            vScrollBarEnabled: false,
            hScrollBarEnabled: false
          });
        } else {
          player.play({
            playView: 'frm_mine'
          });
          api.openFrame({
            name: 'speaker',
            url: './speaker.html',
            pageParam: {
              MuteSta: app.MuteStatus,
              number: app.numbers
            },
            rect: {
              x: 0,
              y: 0,
              w: 'auto',
              h: 'auto'
            },
            bounces: false,
            bgColor: 'rgba(0,0,0,0)'
          });
        }
      },
      full_btn_click: function () {
        app.palyer.stop();
        api.execScript({
          name: 'live_player',
          script: 'app.openfrmFrame(' + (!api.pageParam.fullScreen) + ')'
        });
//          api.openFrame({
//            name: 'frm_mine',
//            url: './frm_mine.html',
//            rect: {
//              x: 0,
//              y: 0,
//              w: 'auto',
//              h: 'auto'
//            },
//            reload: true,
//            pageParam: {
//              session: app.session,
//              fullScreen: !api.pageParam.fullScreen
//            }
//          });
      },
      setFullScreen_No: function () {
        var offset = document.getElementById('view').offsetHeight
        var player = app.palyer;
        player.init({session: app.session});
        player.play({
          playView: 'player',
          rect: {
            x: 0,
            y: 0,
            w: api.frameWidth,
            h: api.frameHeight - 360
          }
        });
        player.setDisplayMode({mode: 'aspectFill'});
        api.openFrame({
          name: 'speaker',
          url: './speaker.html',
          pageParam: {
            MuteSta: app.MuteStatus,
            number: app.numbers
          },
          rect: {
            x: 0,
            y: 0,
            w: 'auto',
            h: offset
          },
          bounces: false,
          bgColor: 'rgba(0,0,0,0)',
          vScrollBarEnabled: false,
          hScrollBarEnabled: false
        });
      },
      closeWins: function () {
        var publisher = api.require('gotyeLivePublisher');
        var core = api.require('gotyeLiveCore');
        var chat = api.require('gotyeLiveChat');
        var player = app.palyer;
        api.setFullScreen({
          fullScreen: false
        });
        player.stop();
        publisher.logout();
        publisher.stop();
        core.destroyRoomSession();
        chat.logout();
        api.closeFrame({
          name: 'speaker'
        });
        setTimeout(function () {
          api.closeWin()
        }, 300)
      },
      show_time: function () {
        var time_now = new Date();  // 获取当前时间
        time_now = time_now.getTime();
        var time_end = new Date(app.startTime).getTime(); // 获取结束时间
        var time_distance = time_end - time_now;  // 结束时间减去当前时间
        var int_day, int_hour, int_minute, int_second;
        if (time_distance >= 0) {
          // 天时分秒换算
          int_day = Math.floor(time_distance / 86400000)
          time_distance -= int_day * 86400000;
          int_hour = Math.floor(time_distance / 3600000)
          time_distance -= int_hour * 3600000;
          int_minute = Math.floor(time_distance / 60000)
          time_distance -= int_minute * 60000;
          int_second = Math.floor(time_distance / 1000)

          // 时分秒为单数时、前面加零站位
          if (int_hour < 10)
            int_hour = "0" + int_hour;
          if (int_minute < 10)
            int_minute = "0" + int_minute;
          if (int_second < 10)
            int_second = "0" + int_second;

          // 显示时间
          app.int_day = int_day;
          app.int_hour = int_hour;
          app.int_minute = int_minute;
          app.int_second = int_second;
          app.timer = setTimeout("app.show_time()", 1000);
        } else {
          app.int_day = '00';
          app.int_hour = '00';
          app.int_minute = '00';
          app.int_second = '00';
          clearTimeout(app.timer)
        }
      }
    }
  })

  function screll_1() {
    var div = document.getElementById('box');
    div.scrollTop = div.scrollHeight;
  }
  function screll_2() {
    var div = document.getElementById('perPage');
    div.scrollTop = div.scrollHeight;
  }
</script>
</html>